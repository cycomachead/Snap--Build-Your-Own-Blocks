# Deploy Snap! to Berkeley & mirrors
version: 2
jobs:
  deploy:
    machine:
      enabled: true
    working_directory: ~/snap
    environment:
      - REPO_PATH: '~/snap/*'
      - ACCOUNT: 'michael@abbenay.cs.berkeley.edu'
    steps:
      - checkout
      - run:
          name: Install sshpass Dependency (sync to Berkeley)
          command: sudo apt-get update; sudo apt-get install sshpass
      - run:
          name: Deploy to cs10.org
          command: |
            cd ~/snap
            git remote add cs10 https://github.com/cs10/snap
            git fetch origin --tags
            latest=$(git describe --tags `git rev-list --tags --max-count=1`)
            git push -f cs10 ${lates}:master
      - run:
          name: Deploy to snap.berkeley.edu
          command: |
            sshpass -p "${REMOTE_PASSWORD}" rsync -avz $REPO_PATH ${ACCOUNT}:~/snapsource/
      # TODO: update SnapCloud repo
  deploy-dev:
    machine:
      enabled: true
    working_directory: ~/snap
    environment:
      - REPO_PATH: '~/snap/*'
      - ACCOUNT: 'michael@abbenay.cs.berkeley.edu'
    steps:
      - checkout
      - run:
          name: Install sshpass Dependency (sync to Berkeley)
          command: sudo apt-get update; sudo apt-get install sshpass
      - run:
          name: Deploy Over SSH (to snapsource/dev)
          command: |
             sshpass -p "${REMOTE_PASSWORD}" rsync -avz $REPO_PATH ${ACCOUNT}:~/snapsource/dev/

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - deploy:
          filters:
            branches:
              ignore: /.*/
            tags:
              # Deploy tags that are version strings.
              only: /^\d\.\d/
      - deploy-dev:
          filters:
            branches:
              only: master
            tags:
              ignore: /.*/
